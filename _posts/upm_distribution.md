---
title: '【Unity】 Unity Package Managerから配布できるようにする'
excerpt: '検索ページでの説明文'
coverImage: '/assets/blog/dynamic-routing/cover.jpg'
date: '2023-06-06'
ogImage:
  url: '/assets/blog/dynamic-routing/cover.jpg'
tags:
  - 'Unity'
---

## 概要

自社 SDK を`Unity Package Manager(UPM)` で配布できるように対応した際に調べたこと。  
`UPM `で配布することのメリットは下記

- SDK 更新時ユーザーは Package Manager から更新をするだけで差分を更新できるため、手動での一部 dll の更新忘れなどがない
- Assets 配下に import されないため、Project が整理される
- デモシーンなど Samples をダウンロードするオプションをつけることも可能

一方、下記の点は面倒

- Script は`Assembly Definition` を作成しないとため、`Trilib` や `UniVRM` など外部リソースを利用する場合、依存関係の登録が必要となる  
  Trilib は AssemblyDefinition をオプションにしていて、自分で展開する必要あったり、UniVRM 関連は複数 asmdef ファイルがあって面倒
- Private Repogitory からの UPM 取得はそのままの git URL からはできない（別途説明予定）

## 手順

1. 配布元 UnityProject で、下記のようなディレクトリ構造を作る

```
<Repository>
├── Assets
│   └── MyPackage
│       ├── Runtime
│       │   ├── MyBehavior1.cs
│       │   ├── MyBehavior2.cs
│       │   └── MyPackage.asmdef
│       ├── Plugins
│       │   ├── MyPlugin
│       │   └── 3rdParty
│       ├── Editor
│       │   ├── MyMenuItem1.cs
│       │   └── MyPackage.Editor.asmdef
│       ├── Samples
│       │   ├── Sample1
│       │   └── Sample2
│       └── package.json
├── Packages
├── .gitattributes
└── .gitignore
```

2. namespace と AssemblyDefinision
   UPM からダウンロードして Package に格納された C# Script(MonoBehaviour や Editor 拡張)は、Assembly Definision とそれに対応した namaspace を持つ場合のみ、機能する。

   - asmdef の作成 > Runtime
     1. Unity Editor で Runtime フォルダに移動。
     2. 右クリックして Create > Assembly Definition を選択。
     3. 新しい Assembly Definition ファイルに[MyPackage]という名前を付け、Enter キーを押して名前を保存。
     4. asmdef のインスペクターを開き、reference を設定する
        1. Assembly Definition References の +ボタン を押す
        2. 必要な Assembly を追加する
           例: UniTask, UniTask.Core, Trilib
   - asmdef の作成 > Editor
     1. Unity Editor で Editor フォルダに移動。
     2. 右クリックして Create > Assembly Definition を選択。
     3. 新しい Assembly Definition ファイルに[MyPackage.Editor]という名前を付け、Enter キーを押して名前を保存。
   - Editor の asmdef > Runtime の asmdef に依存するように設定
     1. [MyPackage.Editor] Assembly Definition ファイルを選択。
     2. Inspector ウィンドウで Assembly Definition References セクションを展開。
     3. +ボタンをクリックし、リストから[MyPackage]を選択して依存関係を追加。
     4. Apply ボタンをクリックして変更を保存。
   - namespace の管理
     asmdef のタイトル名にした名前を namespace にする

   - Trilib は AssemblyDefinitions.zip を展開して、TrilibCore.asmdef を Trilib/TrilibCore/Scripts に格納する

3. .gitattributes 作成
   例

```txt
*.unity -text
*.prefab -text
*.asset -text
* text=auto

*.psd filter=lfs diff=lfs merge=lfs -text
*.png filter=lfs diff=lfs merge=lfs -text
*.jpg filter=lfs diff=lfs merge=lfs -text
*.tga filter=lfs diff=lfs merge=lfs -text
*.tif filter=lfs diff=lfs merge=lfs -text
*.mp3 filter=lfs diff=lfs merge=lfs -text
*.wav filter=lfs diff=lfs merge=lfs -text
*.ogg filter=lfs diff=lfs merge=lfs -text
*.FBX filter=lfs diff=lfs merge=lfs -text
*.fbx filter=lfs diff=lfs merge=lfs -text
*.obj filter=lfs diff=lfs merge=lfs -text
```

4. .gitignore 作成
   例

```txt
/[Ll]ibrary/
/[Tt]emp/
/[Oo]bj/
/[Bb]uild/
/[Bb]uilds/
/Assets/AssetStoreTools*
/Assets/配布禁止の外部アセット*

# Ignore everything in the root folder except specific files
/*

# Don't ignore
!/.gitignore
!/.gitattributes
!/package.json
!/Assets/UAPSDK/
!/Assets/

# Ignore other specific folders and files
.vscode/
Logs/
Packages/
ProjectSettings/
UserSettings/

# Autogenerated VS/MD/Consulo solution and project files
*.csproj
*.unityproj
*.sln
*.suo
*.tmp
*.user
*.userprefs
*.pidb
*.booproj
*.svd

# Unity3D generated meta files
*.pidb.meta

# Unity3D generated file on crash reports
sysinfo.txt

# Builds
*.apk
*.unitypackage
```

5. package.json の作成
   下記 template を利用する  
   package.json は配布したいディレクトリのルートディレクトリにする  
   例 `MyPackage/Plugins` のみ配布する場合は、Plugins 直下に保存する

```json
{
    "name": "com.haluika.samplesdk",
    "version": "0.0.1",
    "displayName": "Sample SDK",
    "description": "A sample SDK for ~~~~~~~~.",
    "unity": "2021.3",
    "dependencies": {
        "ここに記載したpackageがprojectに存在していないと、このpackageはimportできなくなる"
    },
    "keywords": ["keyword1", "keyword2", "keyword3"],
    "author": {
        "name": "haluika",
        "email": "xxxxxx@xxxx.com",
        "url": "https://www.unity3d.com"
    },
    "samples": [
        {
            "displayName": "sample1",
            "description": "test sample",
            "path": "Samples/Sample1"
        },
        {
            "displayName": "sample2",
            "description": "test sample",
            "path": "Samples/Sample2"
        }
    ]
}
```

6. Samples の作成
   package.json の"samples"で指定することによって、UPM に download ボタンを表示させて Assets 下に download させることができる

7. git hub にリポジトリごと push

8. upm 配布から取得する

   - PackageManager の add from git url から取得
   - public の場合の URL: https://github.com/`username`/`repositoryname`.git?path=`path`
   - private の場合の URL: https://`token`@github.com/`username`/`repositoryname`.git?path=`path`

9. token の発行
   git の右上の account icon > settings > Developer settings > personal access token > Tokens(legacy)

## Reference

- Asset 下に置きたいものは samples として管理すればよい[https://qiita.com/r-ngtm/items/305e4810227e360d4f19]
- [https://qiita.com/sator_imaging/items/469ecc69425b1927b603]
